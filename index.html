<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Merkin 200 (2026)</title>
    <!-- Tailwind for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <!-- Babel & Lucide Icons -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
        }
        .animate-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Smooth scrolling for iOS */
        .custom-scroll {
            -webkit-overflow-scrolling: touch;
        }

        /* Gradient mask to fade content before it hits the nav */
        .bottom-fade {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 180px;
            background: linear-gradient(to top, #f8fafc 40%, rgba(248, 250, 252, 0) 100%);
            pointer-events: none;
            z-index: 30;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { 
            AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, 
            ResponsiveContainer, PieChart, Pie, Cell, Legend, ReferenceLine
        } = Recharts;

        // Constants
        const COLORS = ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4'];
        const SHEET_ID = '1gAcN7cONSibBOwN8O2icTiWZHV8mxNkGyx8WiQ004tE';
        const TAB_GID = '2078211101'; 
        const DAILY_GOAL = 200;
        const TOTAL_DAYS = 28;
        const TOTAL_GOAL = 5600;

        const QUOTES = [
            "Leave no man behind, but leave him better than you found him.",
            "Iron sharpens iron.",
            "It's not about the merkins, it's about the man next to you.",
            "The Gloom is where HIMs are made.",
            "DFQ: Don't Forget Quality.",
            "Speed is fine, but accuracy is final.",
            "Pick up the six!"
        ];

        const Icon = ({ name, size = 20, className = "" }) => (
            <i data-lucide={name} style={{ width: size, height: size }} className={`inline-block ${className}`}></i>
        );

        const App = () => {
            const [parsedData, setParsedData] = useState(null);
            const [activeTab, setActiveTab] = useState('summary');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [quoteIdx, setQuoteIdx] = useState(0);

            const today = new Date("2026-02-04T00:00:00");
            const dayOfMonth = today.getDate();
            const currentTarget = dayOfMonth * DAILY_GOAL;

            const fetchData = async () => {
                setLoading(true);
                try {
                    const cacheBuster = new Date().getTime();
                    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${TAB_GID}&t=${cacheBuster}`;
                    const res = await fetch(url);
                    const text = await res.text();
                    parseCSV(text);
                } catch (err) {
                    setError("Failed to sync data.");
                    setLoading(false);
                }
            };

            const getRank = (total) => {
                if (total >= 5000) return "Nat-T";
                if (total >= 3000) return "Site Q";
                if (total >= 1500) return "HIM";
                if (total >= 500) return "PAX";
                return "FNG";
            };

            const parseCSV = (text) => {
                const rows = text.split(/\r?\n/).map(row => {
                    const cells = [];
                    let current = '', inQuotes = false;
                    for (let i = 0; i < row.length; i++) {
                        if (row[i] === '"') inQuotes = !inQuotes;
                        else if (row[i] === ',' && !inQuotes) { cells.push(current.trim()); current = ''; }
                        else current += row[i];
                    }
                    cells.push(current.trim());
                    return cells.map(c => c.replace(/^"|"$/g, ''));
                });

                let nameIdx = rows.findIndex(r => r[0]?.toUpperCase() === "DATE");
                let regionIdx = rows.findIndex(r => r[0]?.toUpperCase() === "REGION");

                if (nameIdx === -1) { setError("Data headers not found."); setLoading(false); return; }

                const people = [];
                rows[nameIdx].slice(1).forEach((name, i) => {
                    if (name && !['TOTAL', 'AVERAGE', 'DATE'].includes(name.toUpperCase())) {
                        people.push({
                            name,
                            region: rows[regionIdx] ? (rows[regionIdx][i + 1] || 'Unknown') : 'Unknown',
                            colIdx: i + 1,
                            total: 0,
                            maxDay: 0,
                            history: []
                        });
                    }
                });

                const dailyTrends = [];
                rows.slice(nameIdx + 1).forEach(row => {
                    const dateStr = row[0];
                    if (!dateStr || /total|average/i.test(dateStr)) return;
                    const rDate = new Date(dateStr);
                    if (isNaN(rDate) || rDate > today) return;

                    let rowSum = 0;
                    people.forEach(p => {
                        const val = parseFloat(row[p.colIdx]?.replace(/,/g, ''));
                        if (!isNaN(val) && val > 0) {
                            p.total += val;
                            if (val > p.maxDay) p.maxDay = val;
                            rowSum += val;
                        }
                    });
                    if (rowSum > 0) dailyTrends.push({ date: dateStr.split('/').slice(0, 2).join('/'), total: rowSum });
                });

                const processed = people.map(p => ({
                    ...p,
                    rank: getRank(p.total),
                    onPace: p.total >= currentTarget,
                    diff: p.total - currentTarget,
                    projected: Math.round((p.total / dayOfMonth) * TOTAL_DAYS)
                }));

                const regionStats = {};
                processed.forEach(p => {
                    if (!regionStats[p.region]) regionStats[p.region] = { total: 0, pCount: 0 };
                    if (p.total > 0) {
                        regionStats[p.region].total += p.total;
                        regionStats[p.region].pCount += 1;
                    }
                });

                setParsedData({
                    people: processed.sort((a,b) => b.total - a.total),
                    dailyTrends,
                    regionData: Object.keys(regionStats).map(k => ({ 
                        name: k, 
                        value: regionStats[k].total,
                        efficiency: Math.round(regionStats[k].total / regionStats[k].pCount) 
                    })),
                    grandTotal: processed.reduce((a,p) => a + p.total, 0),
                    activeCount: processed.filter(p => p.total > 0).length,
                    king: [...processed].sort((a,b) => b.maxDay - a.maxDay)[0]
                });
                setLoading(false);
                setTimeout(() => lucide.createIcons(), 100);
            };

            useEffect(() => { 
                fetchData(); 
                const qTimer = setInterval(() => setQuoteIdx(i => (i + 1) % QUOTES.length), 8000); 
                return () => clearInterval(qTimer); 
            }, []);

            useEffect(() => { 
                lucide.createIcons(); 
            }, [activeTab, loading]);

            if (loading) return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-900 text-white text-center">
                    <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4 mx-auto"></div>
                    <p className="font-black uppercase tracking-widest italic">Syncing the Gloom...</p>
                </div>
            );

            // Updated NavButton with better touch target and active state
            const NavButton = ({ id, label, icon }) => (
                <button 
                    onClick={() => setActiveTab(id)}
                    className={`flex-1 flex flex-col items-center py-3 transition-all relative ${activeTab === id ? 'text-blue-500' : 'text-slate-500 hover:text-slate-400'}`}
                >
                    <Icon name={icon} size={22} className={activeTab === id ? 'scale-110' : 'scale-100'} />
                    <span className={`text-[9px] mt-1 font-black uppercase tracking-tighter ${activeTab === id ? 'opacity-100' : 'opacity-60'}`}>{label}</span>
                    {activeTab === id && (
                        <span className="absolute -top-1 w-1 h-1 bg-blue-500 rounded-full"></span>
                    )}
                </button>
            );

            return (
                <div className="max-w-md mx-auto bg-slate-50 min-h-screen flex flex-col relative overflow-x-hidden">
                    {/* Header */}
                    <header className="bg-white/80 backdrop-blur-md p-6 sticky top-0 z-50 border-b border-slate-100 flex justify-between items-center">
                        <div onClick={() => window.location.reload()} className="cursor-pointer">
                            <h1 className="text-2xl font-black text-slate-900 tracking-tighter italic uppercase leading-none">MERKIN 200</h1>
                            <p className="text-[9px] font-black text-blue-500 uppercase tracking-widest leading-none mt-1">Feb 2026 â€¢ Oklahoma</p>
                        </div>
                        <button onClick={fetchData} className="p-3 bg-slate-100 rounded-xl text-slate-500 active:scale-90 transition-all">
                            <Icon name="refresh-cw" size={18} />
                        </button>
                    </header>

                    {/* Main Content with deep bottom padding */}
                    <main className="flex-grow p-4 space-y-6 pb-52 animate-in">
                        {activeTab === 'summary' && (
                            <div className="space-y-6">
                                {/* Pace Progress Widget */}
                                <div className="bg-slate-900 text-white p-6 rounded-[2.5rem] shadow-2xl relative overflow-hidden border border-slate-800">
                                    <div className="relative z-10">
                                        <div className="flex justify-between items-start mb-2">
                                            <p className="text-[10px] font-black text-slate-500 uppercase tracking-[0.2em]">Target: Day {dayOfMonth}</p>
                                            <span className="bg-emerald-500/20 text-emerald-400 text-[9px] font-black px-2 py-0.5 rounded border border-emerald-500/30 uppercase tracking-tighter">Live</span>
                                        </div>
                                        <h2 className="text-6xl font-black tabular-nums tracking-tighter">{currentTarget.toLocaleString()}</h2>
                                        
                                        <div className="mt-8 space-y-4">
                                            <div>
                                                <div className="flex justify-between text-[10px] font-black uppercase mb-1">
                                                    <span>Goal Progress</span>
                                                    <span>{Math.round((parsedData.grandTotal / (TOTAL_GOAL * parsedData.people.length)) * 100)}%</span>
                                                </div>
                                                <div className="h-2 bg-white/10 rounded-full overflow-hidden">
                                                    <div className="h-full bg-blue-500 rounded-full shadow-[0_0_10px_rgba(59,130,246,0.5)]" style={{ width: `${(parsedData.grandTotal / (TOTAL_GOAL * parsedData.people.length)) * 100}%` }}></div>
                                                </div>
                                            </div>
                                            <div className="flex justify-between border-t border-white/10 pt-4">
                                                <div className="text-center flex-1">
                                                    <p className="text-[8px] font-black text-slate-500 uppercase">Total Reps</p>
                                                    <p className="text-lg font-black text-blue-400">{parsedData.grandTotal.toLocaleString()}</p>
                                                </div>
                                                <div className="text-center flex-1 border-x border-white/10">
                                                    <p className="text-[8px] font-black text-slate-500 uppercase">Tons Moved</p>
                                                    <p className="text-lg font-black text-emerald-400">{(parsedData.grandTotal * 130 / 2000).toFixed(1)}</p>
                                                </div>
                                                <div className="text-center flex-1">
                                                    <p className="text-[8px] font-black text-slate-500 uppercase">Active</p>
                                                    <p className="text-lg font-black text-amber-400">{parsedData.activeCount}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <Icon name="target" size={200} className="absolute -bottom-10 -right-10 opacity-5 rotate-12" />
                                </div>

                                {/* Top King Card */}
                                <div className="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm flex items-center space-x-4">
                                    <div className="bg-amber-100 p-3 rounded-2xl text-amber-600">
                                        <Icon name="crown" size={24} />
                                    </div>
                                    <div className="flex-1">
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">King of the Gloom</p>
                                        <p className="font-black text-slate-900 uppercase italic leading-tight text-lg">{parsedData.king?.name || 'None'}</p>
                                        <p className="text-[10px] font-bold text-slate-400 uppercase leading-none mt-0.5">{parsedData.king?.maxDay || 0} reps in one day</p>
                                    </div>
                                    <Icon name="chevron-right" size={16} className="text-slate-300" />
                                </div>

                                {/* Area Chart */}
                                <div className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
                                    <h3 className="text-[10px] font-black text-slate-400 mb-6 uppercase tracking-[0.2em] flex items-center">
                                        <Icon name="trending-up" size={14} className="mr-2" /> Daily Volume Chart
                                    </h3>
                                    <div className="h-52 w-full">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <AreaChart data={parsedData.dailyTrends}>
                                                <defs>
                                                    <linearGradient id="colorTotal" x1="0" y1="0" x2="0" y2="1">
                                                        <stop offset="5%" stopColor="#2563eb" stopOpacity={0.2}/>
                                                        <stop offset="95%" stopColor="#2563eb" stopOpacity={0}/>
                                                    </linearGradient>
                                                </defs>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                                <XAxis dataKey="date" axisLine={false} tickLine={false} tick={{fontSize: 9, fontWeight: 'bold', fill: '#94a3b8'}} />
                                                <YAxis hide />
                                                <Tooltip contentStyle={{ borderRadius: '16px', border: 'none', boxShadow: '0 10px 15px rgba(0,0,0,0.1)' }} />
                                                <Area type="monotone" dataKey="total" stroke="#2563eb" fill="url(#colorTotal)" strokeWidth={4} />
                                            </AreaChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'leaderboard' && (
                            <div className="space-y-3">
                                <div className="flex justify-between items-end px-2 mb-4">
                                    <div>
                                        <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none">The Leaderboard</h3>
                                        <p className="text-xl font-black text-slate-900 tracking-tighter italic uppercase">Battle Status</p>
                                    </div>
                                    <span className="text-[9px] font-black text-blue-600 bg-blue-50 px-2 py-1 rounded uppercase tracking-tighter">Target: {currentTarget}</span>
                                </div>
                                {parsedData.people.filter(p => p.total > 0).map((p, i) => (
                                    <div key={i} className="bg-white p-5 rounded-[2rem] flex flex-col border border-slate-100 shadow-sm relative overflow-hidden active:scale-[0.98] transition-all">
                                        {p.onPace && <div className="absolute top-0 left-0 h-full w-2 bg-emerald-500"></div>}
                                        
                                        <div className="flex justify-between items-start">
                                            <div className="flex items-center space-x-4">
                                                <div className={`w-10 h-10 rounded-2xl flex items-center justify-center font-black text-sm shadow-sm ${i === 0 ? 'bg-amber-400 text-white' : i === 1 ? 'bg-slate-300 text-white' : i === 2 ? 'bg-orange-400 text-white' : 'bg-slate-100 text-slate-400'}`}>
                                                    {i + 1}
                                                </div>
                                                <div>
                                                    <div className="flex items-center space-x-2">
                                                        <p className="font-black text-lg text-slate-900 uppercase tracking-tighter italic leading-none">{p.name}</p>
                                                        {i === 0 && <Icon name="crown" size={14} className="text-amber-500" />}
                                                        {p.maxDay > 300 && <Icon name="flame" size={14} className="text-rose-500" />}
                                                    </div>
                                                    <div className="flex items-center space-x-2 mt-1.5">
                                                        <span className="text-[9px] font-black bg-slate-900 text-white px-1.5 py-0.5 rounded tracking-tighter uppercase">{p.rank}</span>
                                                        <span className="text-[9px] font-bold text-slate-400 uppercase tracking-widest">{p.region}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <p className="font-black text-2xl text-slate-900 tabular-nums leading-none">{p.total.toLocaleString()}</p>
                                                <p className={`text-[9px] font-black uppercase mt-1 ${p.onPace ? 'text-emerald-500' : 'text-rose-500'}`}>
                                                    {p.onPace ? 'On Pace' : `${Math.abs(p.diff)} Behind`}
                                                </p>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-4 mt-5 pt-4 border-t border-slate-50">
                                            <div>
                                                <p className="text-[8px] font-black text-slate-400 uppercase tracking-tighter">Feb 28 Projection</p>
                                                <p className="text-sm font-black text-blue-600 tabular-nums leading-none mt-1">{p.projected.toLocaleString()}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-[8px] font-black text-slate-400 uppercase tracking-tighter">Single Day Record</p>
                                                <p className="text-sm font-black text-slate-900 tabular-nums leading-none mt-1">{p.maxDay}</p>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'regions' && (
                            <div className="space-y-6">
                                <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 flex flex-col items-center">
                                    <h3 className="text-[10px] font-black text-slate-400 mb-8 uppercase tracking-widest">Regional Rivalry</h3>
                                    <div className="h-64 w-full">
                                        <ResponsiveContainer width="100%" height="100%">
                                            <PieChart>
                                                <Pie data={parsedData.regionData} dataKey="value" innerRadius={70} outerRadius={90} paddingAngle={8} stroke="none">
                                                    {parsedData.regionData.map((e, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} cornerRadius={12} />)}
                                                </Pie>
                                                <Tooltip />
                                                <Legend verticalAlign="bottom" height={36} wrapperStyle={{fontSize: '9px', fontWeight: '900', textTransform: 'uppercase'}}/>
                                            </PieChart>
                                        </ResponsiveContainer>
                                    </div>
                                </div>
                                <div className="space-y-3">
                                    {parsedData.regionData.map((reg, i) => (
                                        <div key={i} className="bg-white p-5 rounded-[1.5rem] flex justify-between items-center border border-slate-100 shadow-sm relative overflow-hidden">
                                            <div className="absolute left-0 top-0 bottom-0 w-2" style={{ backgroundColor: COLORS[i % COLORS.length] }}></div>
                                            <div>
                                                <span className="font-black text-sm uppercase text-slate-900 tracking-tighter">{reg.name}</span>
                                                <p className="text-[9px] font-bold text-slate-400 uppercase tracking-widest">{reg.efficiency} reps per PAX avg</p>
                                            </div>
                                            <div className="text-right">
                                                <span className="font-black text-xl text-slate-900 tabular-nums">{reg.value.toLocaleString()}</span>
                                                <p className="text-[8px] font-black text-slate-400 uppercase leading-none mt-1">Total</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'logs' && (
                            <div className="space-y-3">
                                <div className="bg-blue-600 text-white p-6 rounded-3xl shadow-xl flex items-center space-x-4">
                                    <Icon name="scroll-text" size={32} className="opacity-50" />
                                    <div>
                                        <h3 className="text-[10px] font-black uppercase tracking-[0.2em] mb-1">Audit Trail</h3>
                                        <p className="text-sm font-bold opacity-90 leading-tight italic">Validated data through Feb {dayOfMonth}.</p>
                                    </div>
                                </div>
                                {parsedData.dailyTrends.slice().reverse().map((l, i) => (
                                    <div key={i} className="bg-white p-4 rounded-2xl flex justify-between items-center border border-slate-100 shadow-sm">
                                        <div className="flex items-center space-x-3">
                                            <div className="p-2 bg-slate-50 rounded-lg">
                                                <Icon name="calendar" size={16} className="text-slate-400" />
                                            </div>
                                            <span className="font-black text-sm text-slate-900 italic">{l.date}</span>
                                        </div>
                                        <span className="text-blue-600 font-black tabular-nums text-lg">+{l.total.toLocaleString()}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </main>

                    {/* Gradient Fade Overlay */}
                    <div className="bottom-fade"></div>

                    {/* Mumble Chatter Ticker */}
                    <div className="fixed bottom-28 left-4 right-4 z-40 pointer-events-none">
                        <div className="bg-white/90 backdrop-blur-md px-4 py-2 rounded-2xl shadow-xl border border-slate-200 text-center animate-in mx-auto max-w-xs">
                            <p className="text-[9px] font-black text-blue-500 uppercase tracking-widest mb-0.5 leading-none">Mumble Chatter</p>
                            <p className="text-[10px] font-bold text-slate-900 italic truncate tracking-tight uppercase">"{QUOTES[quoteIdx]}"</p>
                        </div>
                    </div>

                    {/* Navigation Bar */}
                    <div className="fixed bottom-6 left-4 right-4 max-w-sm mx-auto z-50">
                        <nav className="bg-slate-900/95 backdrop-blur-lg p-2 rounded-[2.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.4)] flex justify-between items-center border border-white/10 ring-8 ring-slate-50/50">
                            <NavButton id="summary" label="Mission" icon="layout-dashboard" />
                            <NavButton id="leaderboard" label="PAX" icon="trophy" />
                            <NavButton id="regions" label="Rivalry" icon="swords" />
                            <NavButton id="logs" label="Audit" icon="scroll-text" />
                        </nav>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
